
Caso # 1 -
SELECT *
FROM (

    SELECT E.NOMBRE  || ' ' || E.APELLIDO1 || ' ' || E.APELLIDO2 AS EMPLEADO,
           TO_CHAR(P.FECHA_PEDIDO, 'MM') AS MES,
           TO_CHAR(P.FECHA_PEDIDO, 'YYYY') AS AÑO,
           (D.PRECIO_UNIDAD * D.CANTIDAD) AS MONTO
    FROM JARDINERIA.PEDIDO P
    JOIN JARDINERIA.DETALLE_PEDIDO D ON P.CODIGO_PEDIDO = D.CODIGO_PEDIDO
    JOIN JARDINERIA.CLIENTE CL ON P.CODIGO_CLIENTE = CL.CODIGO_CLIENTE
    JOIN JARDINERIA.EMPLEADO E ON CL.CODIGO_EMPLEADO_REP_VENTAS = E.CODIGO_EMPLEADO
    
    WHERE EXTRACT(MONTH FROM P.FECHA_PEDIDO) IN (1, 2, 4)
        AND EXTRACT(YEAR FROM P.FECHA_PEDIDO) = (
            SELECT MAX(EXTRACT(YEAR FROM FECHA_PEDIDO))
            FROM JARDINERIA.PEDIDO
        )
)
PIVOT (
    SUM(MONTO)
    FOR (MES) IN (('01') AS "ENERO", ('02') AS "FEBRERO ", ('04') AS "ABRIL")
)
ORDER BY EMPLEADO;






Caso # 2 -

SELECT CLI.CIUDAD AS OFICINA,
    CLI.CIUDAD AS CIUDAD_CLIENTE,
    PRO.NOMBRE,
    SUM(DET.CANTIDAD) AS CANTIDAD_VENDIDA,
    SUM(DET.CANTIDAD * DET.PRECIO_UNIDAD) AS MONTO_VENTA
FROM JARDINERIA.PEDIDO PED
JOIN JARDINERIA.DETALLE_PEDIDO DET ON PED.CODIGO_PEDIDO = DET.CODIGO_PEDIDO
JOIN JARDINERIA.PRODUCTO PRO ON DET.CODIGO_PRODUCTO = PRO.CODIGO_PRODUCTO
JOIN JARDINERIA.CLIENTE CLI ON PED.CODIGO_CLIENTE = CLI.CODIGO_CLIENTE
GROUP BY ROLLUP (CLI.CIUDAD, PRO.NOMBRE)




Caso # 3 

WITH QUERY_EMPLEADO_POR_OFICINA AS (
    SELECT E.CODIGO_EMPLEADO, (SELECT O.CIUDAD FROM JARDINERIA.OFICINA O WHERE O.CODIGO_OFICINA = E.CODIGO_OFICINA) AS OFICINA
    FROM JARDINERIA.EMPLEADO E
)

SELECT 
  P.NOMBRE AS PRODUCTO,
  SC.OFICINA AS OFICINA,
  EXTRACT(YEAR FROM PED.FECHA_PEDIDO) AS AÑO,
  SUM(P.PRECIO_VENTA * DET.CANTIDAD) AS MONTO_VENTAS,
  SUM((P.PRECIO_VENTA - P.PRECIO_PROVEEDOR) * DET.CANTIDAD) AS UTILIDAD_NETA,
  LISTAGG(CLI.NOMBRE_CLIENTE, ', ') WITHIN GROUP (ORDER BY CLI.NOMBRE_CLIENTE) AS CLIENTES
FROM 
  JARDINERIA.PEDIDO PED
JOIN 
  JARDINERIA.DETALLE_PEDIDO DET ON PED.CODIGO_PEDIDO = DET.CODIGO_PEDIDO
JOIN 
  JARDINERIA.PRODUCTO P ON DET.CODIGO_PRODUCTO = P.CODIGO_PRODUCTO
JOIN 
  JARDINERIA.CLIENTE CLI ON PED.CODIGO_CLIENTE = CLI.CODIGO_CLIENTE
JOIN 
  QUERY_EMPLEADO_POR_OFICINA SC ON CLI.CODIGO_EMPLEADO_REP_VENTAS = SC.CODIGO_EMPLEADO
GROUP BY 
  P.NOMBRE,
  SC.OFICINA,
  EXTRACT(YEAR FROM PED.FECHA_PEDIDO);


Caso # 4 
SELECT O.CIUDAD AS OFICINA_NOMBRE,
       EXTRACT(MONTH FROM P.FECHA_ENTREGA) AS MES,
       EXTRACT(YEAR FROM P.FECHA_ENTREGA) AS ANIO,
       SUM(DP.CANTIDAD * DP.PRECIO_UNIDAD) AS VENTAS_ACTUALES,
       LAG(SUM(DP.CANTIDAD * DP.PRECIO_UNIDAD)) OVER (PARTITION BY O.CIUDAD, EXTRACT(YEAR FROM P.FECHA_ENTREGA) ORDER BY EXTRACT(MONTH FROM P.FECHA_ENTREGA)) AS VENTAS_ANTERIORES,
       SUM(DP.CANTIDAD * DP.PRECIO_UNIDAD) - LAG(SUM(DP.CANTIDAD * DP.PRECIO_UNIDAD)) OVER (PARTITION BY O.CIUDAD, EXTRACT(YEAR FROM P.FECHA_ENTREGA) ORDER BY EXTRACT(MONTH FROM P.FECHA_ENTREGA)) AS DIFERENCIA,
       (SUM(DP.CANTIDAD * DP.PRECIO_UNIDAD) - LAG(SUM(DP.CANTIDAD * DP.PRECIO_UNIDAD)) OVER (PARTITION BY O.CIUDAD, EXTRACT(YEAR FROM P.FECHA_ENTREGA) ORDER BY EXTRACT(MONTH FROM P.FECHA_ENTREGA))) / LAG(SUM(DP.CANTIDAD * DP.PRECIO_UNIDAD)) OVER (PARTITION BY O.CIUDAD, EXTRACT(YEAR FROM P.FECHA_ENTREGA) ORDER BY EXTRACT(MONTH FROM P.FECHA_ENTREGA)) * 100 AS PORCENTAJE_CRECIMIENTO
FROM PEDIDO P
INNER JOIN DETALLE_PEDIDO DP ON P.CODIGO_PEDIDO = DP.CODIGO_PEDIDO
INNER JOIN CLIENTE C ON P.CODIGO_CLIENTE = C.CODIGO_CLIENTE
INNER JOIN OFICINA O ON O.CODIGO_OFICINA = O.CODIGO_OFICINA
WHERE EXTRACT(YEAR FROM P.FECHA_PEDIDO) = (
        SELECT MAX(EXTRACT(YEAR FROM FECHA_PEDIDO)) FROM PEDIDO)
GROUP BY O.CIUDAD, EXTRACT(YEAR FROM P.FECHA_ENTREGA), EXTRACT(MONTH FROM P.FECHA_ENTREGA)
ORDER BY O.CIUDAD, EXTRACT(YEAR FROM P.FECHA_ENTREGA), EXTRACT(MONTH FROM P.FECHA_ENTREGA);


#5 
WITH MaxYear AS (
    SELECT MAX(EXTRACT(YEAR FROM FECHA_PEDIDO)) AS MaxYear
    FROM PEDIDO
)

SELECT
    O.CIUDAD AS OFICINA,
    P.NOMBRE AS PRODUCTO,
    TO_CHAR(FECHA_PEDIDO, 'MM') AS MES,
    TO_CHAR(FECHA_PEDIDO, 'YYYY') AS ANIO,
    SUM(D.CANTIDAD) AS CANTIDAD_VENDIDA,
    SUM(D.CANTIDAD * D.PRECIO_UNIDAD) AS MONTO_VENTAS
FROM PEDIDO PE
INNER JOIN DETALLE_PEDIDO D ON PE.CODIGO_PEDIDO = D.CODIGO_PEDIDO
INNER JOIN PRODUCTO P ON D.CODIGO_PRODUCTO = P.CODIGO_PRODUCTO
INNER JOIN OFICINA O ON O.CODIGO_OFICINA = O.CODIGO_OFICINA
CROSS JOIN MaxYear
WHERE
    EXTRACT(YEAR FROM PE.FECHA_PEDIDO) = MaxYear.MaxYear
    AND D.CANTIDAD > 10
GROUP BY O.CIUDAD, P.NOMBRE, TO_CHAR(FECHA_PEDIDO, 'MM'), TO_CHAR(FECHA_PEDIDO, 'YYYY')
ORDER BY O.CIUDAD, P.NOMBRE, MES, ANIO;
